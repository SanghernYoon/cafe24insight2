import streamlit as st
import requests
from bs4 import BeautifulSoup
from fpdf import FPDF
import io
import time
import pandas as pd

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Cafe24 ë¡œë”© íƒ€ì„ ì²´í¬",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# CSS ìŠ¤íƒ€ì¼
st.markdown("""
<style>
.main { 
    padding: 0rem 1rem; 
}
.stTextInput > div > div > input { 
    border-radius: 10px; 
}
.stButton>button { 
    border-radius: 10px; 
    width: 100%;
    background-color: #FF4B4B;
    color: white;
}
.metric-card {
    background-color: white;
    padding: 1rem;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}
.performance-metric {
    font-size: 2rem;
    font-weight: bold;
    color: #FF4B4B;
}
</style>
""", unsafe_allow_html=True)

# í—¤ë” ì„¹ì…˜
col1, col2 = st.columns([1, 3])
with col1:
    st.image("https://www.cafe24.com/wp-content/uploads/2020/12/cafe24.svg", width=150)
with col2:
    st.title("ì‡¼í•‘ëª° ë¡œë”© íƒ€ì„ ë¶„ì„")
    st.markdown("ì§ì ‘ ì¸¡ì •ê³¼ Google PageSpeedë¥¼ í†µí•œ í†µí•© ë¶„ì„")

# ì…ë ¥ í¼
with st.form("analysis_form"):
    domain = st.text_input("ë¸Œëœë“œ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”", placeholder="ì˜ˆ: yourdomain.cafe24.com")
    industry = st.selectbox(
        "ì—…ì¢…ì„ ì„ íƒí•˜ì„¸ìš”",
        ["íŒ¨ì…˜", "ë·°í‹°", "ì‹í’ˆ", "ìƒí™œìš©í’ˆ", "ì „ìì œí’ˆ", "ê¸°íƒ€"]
    )
    submitted = st.form_submit_button("ë¶„ì„ ì‹œì‘í•˜ê¸°")

if submitted and domain:
    try:
        # ì§„í–‰ ìƒíƒœ í‘œì‹œ
        status = st.empty()
        status.info("ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...")

        # 1. ì§ì ‘ ë¡œë”© ì‹œê°„ ì¸¡ì •
        direct_timing_results = []
        for i in range(3):  # 3íšŒ ì¸¡ì •
            try:
                # https:// ì œê±°í•˜ê³  ì²˜ë¦¬
                clean_domain = domain.replace("https://", "").replace("http://", "").strip("/")
                start_time = time.time()
                response = requests.get(f"https://{clean_domain}", timeout=10)
                response.raise_for_status()
                load_time = round(time.time() - start_time, 2)
                direct_timing_results.append(load_time)
                status.info(f"ì§ì ‘ ì¸¡ì • ì§„í–‰ ì¤‘... ({i+1}/3)")
            except Exception as e:
                st.error(f"ì§ì ‘ ì¸¡ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                break

        # 2. Google PageSpeed API í˜¸ì¶œ
        status.info("Google PageSpeed ë¶„ì„ ì¤‘...")
        API_KEY = "AIzaSyBo2LdoFNFxphORUYH9beG1TqDn-AFG_II"
        
        try:
            clean_domain = domain.replace("https://", "").replace("http://", "").strip("/")
            url = f"https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://{clean_domain}&key={API_KEY}"
            response = requests.get(url, timeout=100)
            pagespeed_data = response.json()
            
            if "lighthouseResult" in pagespeed_data:
                performance = pagespeed_data["lighthouseResult"]["categories"]["performance"]["score"] * 100
            else:
                st.warning("Google PageSpeed API ì‘ë‹µì—ì„œ ì„±ëŠ¥ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                performance = 50  # ê¸°ë³¸ê°’ ì„¤ì •
        except Exception as e:
            st.warning("Google PageSpeed ë¶„ì„ ì¤‘ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
            performance = 50  # ê¸°ë³¸ê°’ ì„¤ì •

        # ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        status.success("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

        # ê²°ê³¼ë¥¼ 2ê°œì˜ ì—´ë¡œ ë‚˜ëˆ„ì–´ í‘œì‹œ
        col1, col2 = st.columns(2)

        with col1:
            st.markdown("### ğŸ”„ ì§ì ‘ ì¸¡ì • ê²°ê³¼")
            if direct_timing_results:
                avg_load_time = round(sum(direct_timing_results) / len(direct_timing_results), 2)
                st.markdown(f"""
                <div class="metric-card">
                    <h4>í‰ê·  ë¡œë”© ì‹œê°„</h4>
                    <div class="performance-metric">{avg_load_time}ì´ˆ</div>
                    <small>3íšŒ ì¸¡ì • í‰ê· </small>
                </div>
                """, unsafe_allow_html=True)
                
                # ê°œë³„ ì¸¡ì • ê²°ê³¼
                st.markdown("#### ê°œë³„ ì¸¡ì • ê²°ê³¼")
                for idx, time_result in enumerate(direct_timing_results, 1):
                    st.markdown(f"ì¸¡ì • {idx}: {time_result}ì´ˆ")

        with col2:
            st.markdown("### ğŸš€ Google PageSpeed ê²°ê³¼")
            st.markdown(f"""
            <div class="metric-card">
                <h4>ì„±ëŠ¥ ì ìˆ˜</h4>
                <div class="performance-metric">{performance:.0f}/100</div>
                <small>Google PageSpeed ë¶„ì„</small>
            </div>
            """, unsafe_allow_html=True)

        # ì¢…í•© ë¶„ì„ ë° ì œì•ˆ
        st.markdown("### ğŸ“Š ì¢…í•© ë¶„ì„")
        
        # ì¢…í•© ì ìˆ˜ ê³„ì‚°
        load_time_score = max(0, 100 - (avg_load_time * 10))
        avg_score = (performance + load_time_score) / 2

        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("ì§ì ‘ ì¸¡ì • ì ìˆ˜", f"{load_time_score:.0f}/100")
        with col2:
            st.metric("PageSpeed ì ìˆ˜", f"{performance:.0f}/100")
        with col3:
            st.metric("ì¢…í•© ì„±ëŠ¥ ì ìˆ˜", f"{avg_score:.0f}/100")

        # ì„±ëŠ¥ ê°œì„  ì œì•ˆ
        st.markdown("### ğŸ’¡ ê°œì„  ì œì•ˆ")
        suggestions = []
        
        if avg_load_time > 3:
            suggestions.append("- ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ëŠë¦½ë‹ˆë‹¤. í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤ ì—…ê·¸ë ˆì´ë“œë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”.")
        if performance < 70:
            suggestions.append("- Google PageSpeed ì ìˆ˜ê°€ ë‚®ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìµœì í™”ì™€ ìºì‹± ì„¤ì •ì„ í™•ì¸í•´ë³´ì„¸ìš”.")
        
        if suggestions:
            for suggestion in suggestions:
                st.markdown(suggestion)
        else:
            st.markdown("- í˜„ì¬ ì„±ëŠ¥ì´ ì–‘í˜¸í•©ë‹ˆë‹¤. ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ì„ ê¶Œì¥í•©ë‹ˆë‹¤.")

        # PDF ë¦¬í¬íŠ¸ ìƒì„±
        def create_pdf():
            pdf = FPDF()
            pdf.add_page()
            pdf.add_font("NanumGothic", "", "NanumGothicCoding.ttf", uni=True)
            pdf.set_font("NanumGothic", "", 16)
            pdf.cell(200, 10, txt="ì‡¼í•‘ëª° ë¡œë”© íƒ€ì„ ë¶„ì„ ë¦¬í¬íŠ¸", ln=True, align="C")
            pdf.set_font("NanumGothic", "", 12)
            pdf.cell(200, 10, txt=f"ë„ë©”ì¸: {domain}", ln=True, align="L")
            pdf.cell(200, 10, txt=f"ì—…ì¢…: {industry}", ln=True, align="L")
            pdf.cell(200, 10, txt=f"ì§ì ‘ ì¸¡ì • í‰ê·  ë¡œë”© ì‹œê°„: {avg_load_time}ì´ˆ", ln=True, align="L")
            pdf.cell(200, 10, txt=f"Google PageSpeed ì„±ëŠ¥ ì ìˆ˜: {performance:.0f}/100", ln=True, align="L")
            pdf.cell(200, 10, txt=f"ì¢…í•© ì„±ëŠ¥ ì ìˆ˜: {avg_score:.0f}/100", ln=True, align="L")
            
            # ê°œì„  ì œì•ˆ ì¶”ê°€
            pdf.cell(200, 10, txt="ê°œì„  ì œì•ˆ:", ln=True, align="L")
            for suggestion in suggestions:
                pdf.cell(200, 10, txt=suggestion, ln=True, align="L")
                
            return pdf.output(dest="S").encode("latin-1")

        pdf_bytes = create_pdf()
        st.download_button(
            label="PDF ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ",
            data=pdf_bytes,
            file_name="loading_time_report.pdf",
            mime="application/pdf"
        )

    except Exception as e:
        st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
